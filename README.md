### eggjs ğŸ¥š

åŸºäº koa,koa æ˜¯ç”± express åŸç­äººé©¬æ‰“é€ çš„æ¡†æ¶ã€‚

### koa çš„æ´‹è‘±åœˆæ¨¡å‹æ˜¯å•¥ï¼Ÿ

æ´‹è‘±åœˆæ¨¡å‹æŒ‡çš„æ˜¯å¯¹ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºçš„å¤„ç†æœºåˆ¶ï¼Œkoa é€šè¿‡ await å’Œ async å¯ä»¥éå¸¸çµæ´»çš„æ§åˆ¶ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåºï¼Œä½¿å¾—è¯·æ±‚åœ¨é€šè¿‡ä¸­é—´ä»¶å¤„ç†æ—¶å‘ˆç°è¯·æ±‚ç©¿é€æ´‹è‘±ï¼Œç›´è¾¾æ´‹è‘±å¿ƒï¼Œéšååˆä»æ´‹è‘±å¿ƒå‡ºæ¥ç›´è¾¾æ´‹è‘±å¤–è¡¨çš®çš„çŠ¶æ€ï¼Œç§°ä¹‹ä¸ºæ´‹è‘±åœˆæ¨¡å‹ã€‚

### koa è·Ÿ express æ¯”ä¼˜åŠ¿åœ¨å“ªï¼Ÿ

1. æ›´è½»é‡ï¼Œè‡ªèº«ä¸é›†æˆä¸€äº›è·¯ç”±ã€é™æ€èµ„æºå¤„ç†ã€æ¨¡ç‰ˆç­‰åº“ã€‚
2. å¯¹å¼‚æ­¥çš„å¤„ç†å’Œæ”¯æŒæ›´å…ˆè¿›ï¼Œé‡‡ç”¨ async await è¯­æ³•ä»£æ›¿ express çš„å¼‚æ­¥å›è°ƒæ–¹å¼ã€‚

### TODO:æ¨¡ç‰ˆå¼•æ“æ€ä¹ˆæ¸²æŸ“çš„ï¼Ÿ ä¸ºä»€ä¹ˆä½¿ç”¨ vue è„šæ‰‹æ¶åˆå§‹åŒ–ä¸éœ€è¦ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ï¼Ÿ

### æ€ä¹ˆæ§åˆ¶é¡¹ç›®ç¯å¢ƒå˜é‡çš„

1. ç¬¬ä¸€ç§æ–¹æ³•ï¼šæŒ‡å®š config/env
2. ç¬¬äºŒç§æ–¹æ³•ï¼šè¿è¡Œ egg app æ—¶ï¼šæ³¨å…¥ç¯å¢ƒå˜é‡ï¼špackage.json ä¸­ï¼š`"dev:production": "EGG_SERVER_ENV=production egg-bin dev"`

### controller

controller æ–‡ä»¶ä¸­ï¼Œå‡½æ•°ä¸­çš„ this èº«ä¸Šéƒ½æœ‰ä»€ä¹ˆï¼Ÿ
`const { ctx, app, config, service } = this;`

### context

å†™åœ¨ app/extend/context.js é‡Œé¢
context æ˜¯å•¥ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†ä¸°å¯Œ ctx ä¸Šä¸‹æ–‡å¯¹è±¡çš„ï¼Œæ¯”å¦‚è¿™æ–‡ä»¶é‡Œé¢å†™äº†ä¸€ä¸ªå˜é‡å« isIosï¼Œåˆ™æ­¤å˜é‡ä¼šæŒ‚è½½åˆ° ctx èº«ä¸Šã€‚

### helper

å†™åœ¨ app/extend/helper.js é‡Œé¢

helper æ˜¯å•¥ï¼Ÿ å¯ä»¥ç†è§£ä¸ºå·¥å…·å‡½æ•°ï¼Œåœ¨ egg ä¸Šä¸‹æ–‡ ctx ä¸­å¯é€šè¿‡ ctx.helper è®¿é—®å·¥å…·å‡½æ•°ã€‚

### middleware

å†™åœ¨ app/middleware é‡Œé¢ï¼Œé…ç½®åœ¨ config/config.default.js é‡Œé¢ã€‚

### å…³äº app/extend

è¯¥ç›®å½•ä¸‹å¯ä»¥å†™è¿™ä¹ˆå‡ ä¸ªæ–‡ä»¶ï¼šapplication.js context.js request.js response.js helper.js è¿™äº›æ–‡ä»¶çš„ä½œç”¨éƒ½æ˜¯ä¸ºäº†æ‰©å±• Koa ä¸­å¯¹åº”çš„åŸå‹ï¼Œä¾‹å¦‚æ‰©å±• app åŸå‹ã€ctx åŸå‹ã€req åŸå‹ã€res åŸå‹ã€helper åŸå‹ç­‰

### plugins æ’ä»¶

æœ€å¥½æ˜¯å»ºä¸€ä¸ªç›®å½• plugins: è¯¥ç›®å½•éƒ½æ˜¯é€šç”¨çš„æ’ä»¶ã€‚

æ’ä»¶çš„æ³¨å†Œï¼š
config/plugin.js

```
  myplugin: {
    enable: true,
    path: path.join(__dirname, "../plugins/egg-myplugin"), // æ’ä»¶çš„æ³¨å†Œåˆ†ä¸¤ç§æ–¹å¼ï¼špathå’Œpackageï¼Œpathé¡¾åæ€ä¹‰å°±æ˜¯é€šè¿‡è·¯å¾„çš„æ–¹å¼ä½¿ç”¨æ’ä»¶ï¼Œpackageå°±æ˜¯ä»¥è£…åŒ…çš„å½¢å¼å»ä½¿ç”¨æ’ä»¶ã€‚
  },
```

æŠ½ç¦»æˆç‹¬ç«‹çš„æ’ä»¶ï¼š

```
1. å®Œå–„package.jsonï¼Œè¿™æ˜¯npmæ‰€éœ€è¦çš„ï¼Œå¯¹äºeggæ’ä»¶ï¼ŒnpmåŒ…åå’Œæ’ä»¶åä¸åŒï¼Œè§„èŒƒï¼šåŒ…åegg-xx-xxï¼Œæ’ä»¶åï¼šeggXxxXxx
    1. å¢åŠ å­—æ®µ
    "eggPlugin": {
      "name": "myplugin",
      "dependencies": []
    },
2. åˆ‡åˆ°æ’ä»¶ç›®å½•ï¼Œæ— éœ€æ‰“åŒ…
  1. `$ npm login`
  2. `$ npm publish`
```

ä¿®æ”¹æ’ä»¶åœ¨é¡¹ç›®ä¸­çš„ç”¨æ³•ï¼Œåº”æŠŠ path æ”¹æˆ package ç”¨æ³•ã€‚

### æ¡†æ¶å†…ç½®åŸºç¡€å¯¹è±¡

egg åŒ…å«å¾ˆå¤šå†…ç½®å¯¹è±¡ï¼šapplicationã€contextã€requestã€responseã€controllerã€serviveã€loggerã€helperã€configï¼Œå…¶ä¸­å‰å››ä¸ªæ˜¯ç»§æ‰¿äº Koa çš„ï¼Œåé¢çš„æ˜¯ egg è‡ªè¡Œæ‰©å±•çš„ã€‚

### app

egg å®ä¾‹ï¼Œå‡ ä¹å¯ä»¥åœ¨ä»»ä½•åœºæ™¯è·å–åˆ° app å®ä¾‹ï¼Œåœ¨å…¶ä¸Šå¯ä»¥æŒ‚è½½ä¸€äº›æ–¹æ³•å’Œå±æ€§ã€‚

### context

context å®é™…ä¸Šæ˜¯ä¸€ä¸ªè¯·æ±‚çº§åˆ«çš„å¯¹è±¡ï¼Œæ¯å½“æ”¶åˆ°ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šé‡æ–°åŒ…è£…æˆä¸€ä¸ª context å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«æœ‰è¯·æ±‚ä¿¡æ¯ä»¥åŠå¯ä»¥è®¾ç½®å“åº”ä¿¡æ¯ï¼Œæ‰€æœ‰çš„ service ä¹Ÿä¼šè¢«æŒ‚è½½åˆ° context ä¸Šï¼Œè¿˜æœ‰å¦å¤–çš„ä¸€äº›å±æ€§å’Œæ–¹æ³•ã€‚

ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»º ctx å¯¹è±¡ï¼š`const ctx = app.createAnonymousContext();`

### helper

helper ä¸­æ–¹æ³•ä¹Ÿå¯ä»¥æ‹¿åˆ°å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

### config

éµå¾ªé…ç½®å’Œä»£ç åˆ†ç¦»çš„åŸåˆ™ï¼Œé¡¹ç›®å¯åŠ¨åä¼šæŠŠåˆå¹¶åçš„æœ€ç»ˆé…ç½®è¾“å‡ºåˆ° `run/application_config.jsonï¼ˆworker è¿›ç¨‹ï¼‰`å’Œ `run/agent_config.jsonï¼ˆagent è¿›ç¨‹ï¼‰`ä¸­ï¼Œä»¥ä¾›é—®é¢˜åˆ†æã€‚

### middleware

ç¼–å†™ä¸­é—´ä»¶ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæœ‰ next å’Œ ctx å‚æ•°å¯å¯¹è¯·æ±‚æˆ–è€…å“åº”æˆ–è€…ä¸Šä¸‹æ–‡å¯¹è±¡åšå¤„ç†ã€‚
ä½¿ç”¨ä¸­é—´ä»¶ï¼šä¸­é—´ä»¶å¿…é¡»æ‰‹åŠ¨æŒ‚è½½å¹¶ä¸”æŒ‡å®šä¸­é—´ä»¶çš„å…ˆåæ‰§è¡Œé¡ºåºã€‚

- åœ¨åº”ç”¨ä¸­ä½¿ç”¨ä¸­é—´ä»¶ï¼š

  - åœ¨ config.default.js ä¸­å£°æ˜

    ```js
    module.exports = {
      // é…ç½®éœ€è¦çš„ä¸­é—´ä»¶ï¼Œæ•°ç»„é¡ºåºå³ä¸ºä¸­é—´ä»¶çš„åŠ è½½é¡ºåº
      middleware: ["gzip"],

      // é…ç½® gzip ä¸­é—´ä»¶çš„é…ç½®
      gzip: {
        threshold: 1024, // å°äº 1k çš„å“åº”ä½“ä¸å‹ç¼©
      },
    };
    ```

  ```

  ```

- åœ¨æ¡†æ¶å’Œæ’ä»¶ä¸­ä½¿ç”¨ä¸­é—´ä»¶ï¼Œè¿™æ—¶å€™ä¸æ”¯æŒåœ¨ config.default.js ä¸­è¿›è¡Œé…ç½®ï¼Œè¦åœ¨ app.js ä¸­è¿›è¡Œé…ç½®

  ```js
  // app.js
  module.exports = (app) => {
    // åœ¨ä¸­é—´ä»¶æœ€å‰é¢ç»Ÿè®¡è¯·æ±‚æ—¶é—´
    app.config.coreMiddleware.unshift("report");
  };
  ```

- åœ¨è·¯ç”±ä¸­ä½¿ç”¨ä¸­é—´ä»¶ï¼Œæ— è®ºæ˜¯åº”ç”¨ä¸­é—´ä»¶è¿˜æ˜¯æ’ä»¶æˆ–è€…æ¡†æ¶ä¸­é—´ä»¶ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å…¨å±€ä¸­é—´ä»¶ï¼Œè·¯ç”±ä¸­é—´ä»¶æ”¯æŒå¯¹äºç‰¹å®šçš„è¯·æ±‚åº”ç”¨ä¸­é—´ä»¶ï¼š
  ```js
  // app/router.js
  module.exports = (app) => {
    const gzip = app.middleware.gzip({ threshold: 1024 });
    app.router.get("/needgzip", gzip, app.controller.handler);
  };
  ```

#### é…ç½® middleware

- enableï¼šæ§åˆ¶ä¸­é—´ä»¶æ˜¯å¦å¼€å¯ã€‚
- matchï¼šè®¾ç½®åªæœ‰ç¬¦åˆæŸäº›è§„åˆ™çš„è¯·æ±‚æ‰ä¼šç»è¿‡è¿™ä¸ªä¸­é—´ä»¶ã€‚
- ignoreï¼šè®¾ç½®ç¬¦åˆæŸäº›è§„åˆ™çš„è¯·æ±‚ä¸ç»è¿‡è¿™ä¸ªä¸­é—´ä»¶ã€‚

```js
module.exports = {
  bodyParser: {
    enable: false, // å…³é—­ bodyParser è¿™ä¸ªä¸­é—´ä»¶
  },
};
```

`matchå’Œignoreä¸å¯åŒæ—¶å¼€å¯ï¼Œä¸¤è€…éƒ½æ”¯æŒç›¸åŒçš„é…ç½®æ–¹å¼ï¼šå­—ç¬¦ä¸²ã€æ­£åˆ™ã€å‡½æ•°`;

- å­—ç¬¦ä¸²ï¼šå½“å‚æ•°ä¸ºå­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œé…ç½®çš„æ˜¯ä¸€ä¸ª url çš„è·¯å¾„å‰ç¼€ï¼Œæ‰€æœ‰ä»¥é…ç½®çš„å­—ç¬¦ä¸²ä½œä¸ºå‰ç¼€çš„ url éƒ½ä¼šåŒ¹é…ä¸Šã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ•°ç»„ã€‚
- æ­£åˆ™ï¼šå½“å‚æ•°ä¸ºæ­£åˆ™æ—¶ï¼Œç›´æ¥åŒ¹é…æ»¡è¶³æ­£åˆ™éªŒè¯çš„ url çš„è·¯å¾„ã€‚
- å‡½æ•°ï¼šå½“å‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¼šå°†è¯·æ±‚ä¸Šä¸‹æ–‡ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°ï¼Œæœ€ç»ˆå–å‡½æ•°è¿”å›çš„ç»“æœï¼ˆtrue/falseï¼‰æ¥åˆ¤æ–­æ˜¯å¦åŒ¹é…ã€‚

### router

åŸºæœ¬ç”¨æ³•ï¼š

```js
// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get("/user/:id", controller.user.info);
  router.post("/user", controller.user.create);
  router.post("/admin", isAdmin, controller.admin); // æ­¤è·¯ç”±ä½¿ç”¨äº†isAdminä¸­é—´ä»¶
};
```

é‡å®šå‘ï¼š

1. å†…éƒ¨é‡å®šå‘
   ```js
   // app/router.js
   module.exports = (app) => {
     app.router.get("index", "/home/index", app.controller.home.index);
     app.router.redirect("/", "/home/index", 302);
   };
   ```
2. å¤–éƒ¨é‡å®šå‘

   ```js
   // app/controller/search.js
   exports.index = async (ctx) => {
     const type = ctx.query.type;
     const q = ctx.query.q || "nodejs";

     if (type === "bing") {
       ctx.redirect(`http://cn.bing.com/search?q=${q}`);
     } else {
       ctx.redirect(`https://www.google.co.kr/search?q=${q}`);
     }
   };
   ```

### è®¢é˜…æ¨¡å‹

Subscription åŸºç±»ï¼šè®¢é˜…æ¨¡å‹æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„å¼€å‘æ¨¡å¼ï¼Œegg æä¾›äº† Subscription åŸºç±»æ¥è§„èŒƒåŒ–è¿™ä¸ªæ¨¡å¼ã€‚

```javascript
const Subscription = require("egg").Subscription;

class Schedule extends Subscription {
  // éœ€è¦å®ç°æ­¤æ–¹æ³•
  // subscribe å¯ä»¥ä¸º async function æˆ– generator function
  async subscribe() {}
}
```

## è¿è¡Œç¯å¢ƒ

### æŒ‡å®šè¿è¡Œç¯å¢ƒ

1. é€šè¿‡ config/env æ–‡ä»¶æŒ‡å®šï¼Œè¯¥æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹å°±æ˜¯è¿è¡Œç¯å¢ƒï¼Œå¦‚ï¼šproductionã€simulation
2. é€šè¿‡åœ¨å¯åŠ¨ egg åº”ç”¨æ—¶æ³¨å…¥ç¯å¢ƒå˜é‡ï¼šEGG_SERVER_ENV=production npm start

### è·å–è¿è¡Œç¯å¢ƒ

`app.config.env`

### EGG_SERVER_ENV ä¸ NODE_ENV çš„åŒºåˆ«

å‰è€…å¯¹äºç¯å¢ƒå˜é‡çš„ç®¡ç†æ›´åŠ ç²¾ç»†ï¼Œå»ºè®®åœ¨ egg åº”ç”¨ä¸­ä½¿ç”¨å‰è€…ã€‚
